<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Electric Power Calculator</title>
    <link rel="icon" type="image/png" th:href="@{/favicon.png}" />

    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"
      rel="stylesheet"
    />
    <script th:inline="javascript">
      const csrfToken = /*[[${_csrf.token}]]*/ "";
      const csrfHeader = /*[[${_csrf.headerName}]]*/ "";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Custom styles for a more modern look */
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
      }

      .bg-gradient-custom {
        background: linear-gradient(135deg, #1a1c2d 0%, #121420 100%);
      }

      .card-glass {
        background: rgba(30, 32, 47, 0.6);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(79, 84, 121, 0.15);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: rgba(79, 84, 121, 0.15);
        border: 1px solid rgba(79, 84, 121, 0.3);
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: rgba(79, 84, 121, 0.25);
      }

      .nav-item {
        transition: all 0.2s ease;
      }

      .nav-item-active {
        background: rgba(99, 102, 241, 0.2);
        border-left: 3px solid #6366f1;
      }

      .input-field {
        background: rgba(30, 32, 47, 0.6);
        border: 1px solid rgba(79, 84, 121, 0.3);
        transition: all 0.3s ease;
      }

      .input-field:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
      }

      /* Custom range slider styling */
      input[type="range"] {
        -webkit-appearance: none;
        height: 6px;
        background: rgba(79, 84, 121, 0.3);
        border-radius: 5px;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(99, 102, 241, 0.5);
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 5px rgba(99, 102, 241, 0.5);
      }

      .progress-bar {
        height: 6px;
        border-radius: 3px;
        background: rgba(79, 84, 121, 0.3);
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
      }

      /* Custom select styling */
      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
      }

      /* Tab transitions */
      .content-tab {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .content-tab.active {
        display: block;
        opacity: 1;
      }

      /* Custom scrollbar for history view */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(30, 32, 47, 0.3);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.7);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-custom text-gray-200"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  >
    <div class="container mx-auto py-8 px-4">
      <nav class="mb-6">
        <div class="flex justify-end items-center">
          <div>
            <div sec:authorize="isAuthenticated()">
              Welcome,
              <span th:text="${#strings.capitalize(displayName)}"></span> |
              <form th:action="@{/logout}" method="post" class="inline">
                <input
                  type="hidden"
                  th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}"
                />
                <button
                  type="submit"
                  class="text-indigo-400 hover:underline bg-transparent border-none cursor-pointer"
                >
                  Logout
                </button>
              </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
              <a href="/login" class="text-indigo-400 hover:underline mr-4"
                >Login</a
              >
              <a href="/signup" class="text-indigo-400 hover:underline"
                >Sign Up</a
              >
            </div>
          </div>
        </div>
      </nav>
      <div class="max-w-6xl mx-auto py-8">
        <!-- Header -->
        <div class="text-center mb-10 animate__animated animate__fadeInDown">
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-2 text-white">
            Electric Power Calculator
          </h1>
          <p class="text-gray-400 max-w-2xl mx-auto">
            Track your energy consumption and estimate costs with our
            interactive calculator
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Navigation -->
          <div class="lg:col-span-1 animate__animated animate__fadeInLeft">
            <div class="card-glass rounded-xl overflow-hidden">
              <div class="flex flex-col">
                <a
                  href="#"
                  data-tab="input"
                  class="nav-link flex items-center gap-3 p-4 transition-all nav-item nav-item-active text-indigo-400"
                >
                  <div class="p-2 rounded-full bg-indigo-900/30">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <polygon
                        points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                      ></polygon>
                    </svg>
                  </div>
                  <span class="font-medium">Calculate Usage</span>
                </a>

                <a
                  href="#"
                  data-tab="results"
                  class="nav-link flex items-center gap-3 p-4 transition-all nav-item text-gray-400 hover:bg-opacity-5 hover:bg-white"
                  th:data-disabled="${usageHistory.isEmpty()}"
                >
                  <div class="p-2 rounded-full bg-purple-900/30">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                      <line x1="3" y1="9" x2="21" y2="9"></line>
                      <line x1="3" y1="15" x2="21" y2="15"></line>
                      <line x1="9" y1="9" x2="9" y2="21"></line>
                      <line x1="15" y1="9" x2="15" y2="21"></line>
                    </svg>
                  </div>
                  <span class="font-medium">Latest Results</span>
                </a>

                <a
                  href="#"
                  data-tab="history"
                  class="nav-link flex items-center gap-3 p-4 transition-all nav-item text-gray-400 hover:bg-opacity-5 hover:bg-white"
                >
                  <div class="p-2 rounded-full bg-indigo-900/30">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-5 w-5"
                    >
                      <path
                        d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                      ></path>
                      <path d="M3 3v5h5"></path>
                      <path d="M12 7v5l4 2"></path>
                    </svg>
                  </div>
                  <span class="font-medium">Usage History</span>
                  <span
                    th:if="${!usageHistory.isEmpty()}"
                    class="ml-auto bg-indigo-500 text-white text-xs px-2 py-1 rounded-full"
                    th:text="${#numbers.formatInteger(recordCount, 1, 'COMMA')}"
                    id="historyCount"
                  ></span>
                </a>
              </div>

              <!-- Stats Summary -->
              <div
                th:if="${!usageHistory.isEmpty()}"
                class="p-5 border-t border-gray-800"
                id="statsSummary"
              >
                <h3 class="text-gray-400 text-sm font-medium mb-4">
                  Usage Summary
                </h3>

                <div class="space-y-5">
                  <div>
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-400">Total Energy</span>
                      <span
                        class="text-white font-medium"
                        th:text="${#numbers.formatDecimal(totalEnergy, 1, 'COMMA', 2, 'POINT') + ' kWh'}"
                        id="totalEnergyDisplay"
                      ></span>
                    </div>
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        th:style="'width: ' + ${totalEnergy > 10 ? 100 : totalEnergy * 10} + '%'"
                        id="totalEnergyBar"
                      ></div>
                    </div>
                  </div>

                  <div>
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-400">Total Cost</span>
                      <span
                        class="text-white font-medium"
                        th:text="${'₦' + #numbers.formatDecimal(totalCost, 1, 'COMMA', 2, 'POINT')}"
                        id="totalCostDisplay"
                      ></span>
                    </div>
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        th:style="'width: ' + ${totalCost > 1000 ? 100 : totalCost / 10} + '%'"
                        id="totalCostBar"
                      ></div>
                    </div>
                  </div>

                  <div>
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-400">Items Tracked</span>
                      <span
                        class="text-white font-medium"
                        th:text="${#numbers.formatInteger(recordCount, 1, 'COMMA')}"
                        id="recordCountDisplay"
                      ></span>
                    </div>
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        th:style="'width: ' + ${recordCount > 10 ? 100 : recordCount * 10} + '%'"
                        id="recordCountBar"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content Area -->
          <div class="lg:col-span-2 animate__animated animate__fadeInUp">
            <div class="card-glass rounded-xl h-full p-6">
              <!-- Input View -->
              <div id="input-tab" class="content-tab active">
                <div class="flex items-center gap-4 mb-6">
                  <div
                    class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-6 w-6 text-white"
                    >
                      <polygon
                        points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                      ></polygon>
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">
                      Calculate Power Usage
                    </h2>
                    <p class="text-gray-400 text-sm">
                      Select an appliance and set usage duration
                    </p>
                  </div>
                </div>

                <form
                  id="calculationForm"
                  th:action="@{/calculate}"
                  method="post"
                  class="space-y-6"
                >
                  <div class="space-y-2">
                    <label
                      for="selectedAppliance"
                      class="block text-gray-300 flex items-center gap-2"
                    >
                      <div id="applianceIcon">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="h-4 w-4"
                        >
                          <polygon
                            points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                          ></polygon>
                        </svg>
                      </div>
                      Select Appliance
                    </label>
                    <select
                      id="selectedAppliance"
                      name="selectedAppliance"
                      onchange="updateApplianceDetails(this.value)"
                      class="w-full px-4 py-3 rounded-lg input-field text-white focus:outline-none"
                    >
                      <option value="" class="bg-gray-900 text-gray-400">
                        Choose an appliance
                      </option>
                      <option
                        th:each="appliance : ${appliances}"
                        th:value="${appliance.name}"
                        th:text="${appliance.name + ' (' + #numbers.formatInteger(appliance.wattage, 1, 'COMMA') + 'W)'}"
                        class="bg-gray-900 text-white"
                      ></option>
                      <option value="custom" class="bg-gray-900 text-white">
                        Custom Appliance
                      </option>
                    </select>
                  </div>

                  <div
                    id="customApplianceField"
                    class="space-y-2"
                    style="display: none"
                  >
                    <label for="customAppliance" class="block text-gray-300"
                      >Custom Appliance Name</label
                    >
                    <input
                      type="text"
                      id="customAppliance"
                      name="customAppliance"
                      placeholder="Enter appliance name"
                      class="w-full px-4 py-3 rounded-lg input-field text-white placeholder:text-gray-500 focus:outline-none"
                    />
                  </div>

                  <div class="space-y-2">
                    <label for="wattage" class="block text-gray-300"
                      >Wattage (W)</label
                    >
                    <input
                      type="text"
                      id="wattage"
                      name="wattage"
                      placeholder="Enter wattage in watts"
                      required
                      class="w-full px-4 py-3 rounded-lg input-field text-white placeholder:text-gray-500 focus:outline-none"
                      oninput="formatNumber(this)"
                    />
                  </div>

                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <label
                        for="hoursUsed"
                        class="block text-gray-300 flex items-center gap-2"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="h-4 w-4"
                        >
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Usage Duration:
                        <span class="text-white font-medium" id="hoursDisplay"
                          >1 hours</span
                        >
                      </label>
                      <select
                        id="timeUnit"
                        name="timeUnit"
                        onchange="updateSliderMax(this.value)"
                        class="px-3 py-2 rounded-lg input-field text-white focus:outline-none text-sm w-[110px]"
                      >
                        <option value="hours" class="bg-gray-900 text-white">
                          Hours
                        </option>
                        <option value="days" class="bg-gray-900 text-white">
                          Days
                        </option>
                        <option value="weeks" class="bg-gray-900 text-white">
                          Weeks
                        </option>
                        <option value="months" class="bg-gray-900 text-white">
                          Months
                        </option>
                      </select>
                    </div>
                    <input
                      type="range"
                      id="hoursUsed"
                      name="hoursUsed"
                      min="0.1"
                      max="24"
                      step="0.1"
                      value="1"
                      oninput="updateHoursDisplay(this.value, document.getElementById('timeUnit').value)"
                      class="w-full"
                    />
                    <div
                      class="flex justify-between text-xs text-gray-500"
                      id="sliderLabels"
                    >
                      <span>0.1h</span>
                      <span>6h</span>
                      <span>12h</span>
                      <span>18h</span>
                      <span>24h</span>
                    </div>
                  </div>

                  <div class="flex gap-4 pt-6">
                    <button
                      type="reset"
                      class="px-5 py-2.5 rounded-lg btn-secondary text-gray-300"
                      onclick="resetForm()"
                    >
                      Clear
                    </button>
                    <button
                      type="submit"
                      class="px-5 py-2.5 rounded-lg btn-primary text-white font-medium ml-auto"
                    >
                      Calculate Usage
                    </button>
                  </div>
                </form>
              </div>

              <!-- Results View -->
              <div id="results-tab" class="content-tab">
                <div class="flex items-center gap-4 mb-8">
                  <div
                    class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center shadow-lg"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-6 w-6 text-white"
                    >
                      <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                      <line x1="3" y1="9" x2="21" y2="9"></line>
                      <line x1="3" y1="15" x2="21" y2="15"></line>
                      <line x1="9" y1="9" x2="9" y2="21"></line>
                      <line x1="15" y1="9" x2="15" y2="21"></line>
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">Latest Results</h2>
                    <p class="text-gray-400 text-sm">
                      Your most recent power calculation
                    </p>
                  </div>
                </div>

                <div
                  id="resultsContent"
                  th:if="${!usageHistory.isEmpty()}"
                  class="grid grid-cols-1 md:grid-cols-2 gap-6"
                >
                  <div
                    class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 rounded-xl p-6 border border-gray-700 shadow-lg"
                  >
                    <div class="flex items-center gap-3 mb-4">
                      <div
                        class="p-3 rounded-lg bg-indigo-900/50"
                        id="resultApplianceIcon"
                        th:data-appliance="${usageHistory[0].applianceName}"
                      >
                        <!-- Will be replaced by JavaScript -->
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="h-5 w-5"
                        >
                          <polygon
                            points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                          ></polygon>
                        </svg>
                      </div>
                      <div>
                        <h3
                          class="font-medium text-white"
                          th:text="${usageHistory[0].applianceName}"
                          id="resultApplianceName"
                        ></h3>
                        <p
                          class="text-gray-400 text-sm"
                          th:text="${#numbers.formatInteger(usageHistory[0].wattage, 1, 'COMMA') + ' watts • ' + usageHistory[0].hoursUsed + ' ' + usageHistory[0].timeUnit}"
                          id="resultApplianceDetails"
                        ></p>
                      </div>
                    </div>

                    <div class="space-y-4 mt-6">
                      <div>
                        <p class="text-gray-400 text-sm mb-1">
                          Energy Consumption
                        </p>
                        <div class="flex items-baseline">
                          <span
                            class="text-3xl font-bold text-white"
                            th:text="${#numbers.formatDecimal(usageHistory[0].kWhConsumed, 1, 'COMMA', 2, 'POINT')}"
                            id="resultKwh"
                          ></span>
                          <span class="text-gray-400 ml-2">kWh</span>
                        </div>
                        <div class="progress-bar mt-2">
                          <div
                            class="progress-fill"
                            th:style="'width: ' + ${usageHistory[0].kWhConsumed > 5 ? 100 : usageHistory[0].kWhConsumed * 20} + '%'"
                            id="resultKwhBar"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div
                    class="bg-gradient-to-br from-gray-900/80 to-indigo-900/40 rounded-xl p-6 border border-gray-700 shadow-lg"
                  >
                    <h3 class="text-lg font-medium text-white mb-4">
                      Cost Estimate
                    </h3>

                    <div class="flex items-center justify-center my-4">
                      <span class="text-green-400 font-bold text-2xl mr-1"
                        >₦</span
                      >
                      <span
                        class="text-5xl font-bold text-white"
                        th:text="${#numbers.formatDecimal(usageHistory[0].cost, 1, 'COMMA', 2, 'POINT')}"
                        id="resultCost"
                      ></span>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-700">
                      <p
                        class="text-gray-400 text-sm"
                        th:text="${'This is approximately ' + #numbers.formatDecimal((usageHistory[0].cost / 1000) * 100, 1, 'COMMA', 1, 'POINT') + '% of a ₦1,000 daily energy budget'}"
                        id="resultBudgetPercent"
                      ></p>
                      <div class="progress-bar mt-2">
                        <div
                          class="progress-fill"
                          th:style="'width: ' + ${usageHistory[0].cost > 1000 ? 100 : (usageHistory[0].cost / 1000) * 100} + '%'"
                          id="resultCostBar"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  id="noResultsMessage"
                  class="text-center py-16 bg-gray-900/30 rounded-lg border border-gray-800"
                  style="display: none"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="h-16 w-16 text-indigo-400 mx-auto mb-6 opacity-40"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="3" y1="15" x2="21" y2="15"></line>
                    <line x1="9" y1="9" x2="9" y2="21"></line>
                    <line x1="15" y1="9" x2="15" y2="21"></line>
                  </svg>
                  <h3 class="text-xl font-medium text-white mb-3">
                    No Results Yet
                  </h3>
                  <p class="text-gray-400 mb-8">
                    Calculate some appliance usage to see your results
                  </p>
                  <a
                    href="#"
                    onclick="switchTab('input'); return false;"
                    class="px-5 py-2.5 rounded-lg btn-primary text-white inline-flex items-center gap-2 font-medium"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-4 w-4"
                    >
                      <path d="M5 12h14"></path>
                      <path d="M12 5v14"></path>
                    </svg>
                    Calculate Now
                  </a>
                </div>

                <div class="mt-8 flex justify-end">
                  <a
                    href="#"
                    onclick="switchTab('input'); return false;"
                    class="px-5 py-2.5 rounded-lg btn-primary text-white font-medium"
                  >
                    Calculate Another
                  </a>
                </div>
              </div>

              <!-- History View -->
              <div id="history-tab" class="content-tab">
                <div class="flex items-center justify-between mb-8">
                  <div class="flex items-center gap-4">
                    <div
                      class="h-12 w-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="h-6 w-6 text-white"
                      >
                        <path
                          d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                        ></path>
                        <path d="M3 3v5h5"></path>
                        <path d="M12 7v5l4 2"></path>
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-xl font-bold text-white">
                        Usage History
                      </h2>
                      <p class="text-gray-400 text-sm">
                        Your tracked power consumption
                      </p>
                    </div>
                  </div>

                  <a
                    href="#"
                    id="clearAllLink"
                    onclick="clearAllUsages(); return false;"
                    th:data-href="@{/delete-all}"
                    class="px-3 py-1.5 border border-gray-700 text-gray-400 rounded-lg text-sm flex items-center gap-1.5 hover:bg-gray-800 hover:text-white transition shadow-sm"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-4 w-4"
                    >
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Clear All
                  </a>
                </div>

                <div
                  id="historyContent"
                  th:if="${!usageHistory.isEmpty()}"
                  class="space-y-5 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar"
                >
                  <div
                    th:each="record : ${usageHistory}"
                    th:id="'history-item-' + ${record.id}"
                    class="history-item bg-gray-900/60 rounded-lg p-5 hover:bg-gray-800/60 transition-colors animate__animated animate__fadeIn shadow-md border border-gray-800/60"
                  >
                    <div class="flex justify-between">
                      <div class="flex items-center gap-3">
                        <div
                          class="p-2.5 bg-indigo-900/30 rounded-lg history-appliance-icon"
                          th:data-appliance="${record.applianceName}"
                        >
                          <!-- Will be replaced by JavaScript -->
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="h-5 w-5"
                          >
                            <polygon
                              points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                            ></polygon>
                          </svg>
                        </div>
                        <div>
                          <h4
                            class="font-medium text-white"
                            th:text="${record.applianceName}"
                          ></h4>
                          <p
                            class="text-gray-400 text-xs"
                            th:text="${#temporals.format(record.recordedAt, 'dd MMM yyyy, HH:mm')}"
                          ></p>
                        </div>
                      </div>
                      <a
                        href="#"
                        th:onclick="'deleteUsage(' + ${record.id} + '); return false;'"
                        th:data-id="${record.id}"
                        th:data-href="@{/delete/{id}(id=${record.id})}"
                        class="delete-link h-8 w-8 flex items-center justify-center text-gray-500 hover:text-white hover:bg-gray-700 rounded-md transition"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="h-4 w-4"
                        >
                          <path d="M3 6h18"></path>
                          <path
                            d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
                          ></path>
                          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </a>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                      <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-gray-400 text-xs">Wattage</p>
                        <p
                          class="text-white font-medium"
                          th:text="${#numbers.formatInteger(record.wattage, 1, 'COMMA') + ' W'}"
                        ></p>
                      </div>
                      <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-gray-400 text-xs">Duration</p>
                        <p
                          class="text-white font-medium"
                          th:text="${record.hoursUsed + ' ' + record.timeUnit}"
                        ></p>
                      </div>
                      <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-gray-400 text-xs">Energy</p>
                        <p
                          class="text-white font-medium"
                          th:text="${#numbers.formatDecimal(record.kWhConsumed, 1, 'COMMA', 2, 'POINT') + ' kWh'}"
                        ></p>
                      </div>
                      <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-gray-400 text-xs">Cost</p>
                        <p
                          class="text-white font-medium"
                          th:text="${'₦' + #numbers.formatDecimal(record.cost, 1, 'COMMA', 2, 'POINT')}"
                        ></p>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  id="noHistoryMessage"
                  class="text-center py-16 bg-gray-900/30 rounded-lg border border-gray-800"
                  style="display: none"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="h-16 w-16 text-indigo-400 mx-auto mb-6 opacity-40"
                  >
                    <path
                      d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                    ></path>
                    <path d="M3 3v5h5"></path>
                    <path d="M12 7v5l4 2"></path>
                  </svg>
                  <h3 class="text-xl font-medium text-white mb-3">
                    No History Yet
                  </h3>
                  <p class="text-gray-400 mb-8">
                    Calculate some appliance usage to see your history
                  </p>
                  <a
                    href="#"
                    onclick="switchTab('input'); return false;"
                    class="px-5 py-2.5 rounded-lg btn-primary text-white inline-flex items-center gap-2 font-medium"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-4 w-4"
                    >
                      <path d="M5 12h14"></path>
                      <path d="M12 5v14"></path>
                    </svg>
                    Calculate Now
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Energy Saving Tips -->
        <div
          class="mt-10 animate__animated animate__fadeInUp animate__delay-1s"
        >
          <div class="card-glass rounded-xl p-6">
            <h3 class="text-xl font-bold text-white mb-6">
              Energy Saving Tips
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div
                class="bg-gray-800/30 p-5 rounded-xl border border-gray-700/50 shadow-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-7 w-7 text-yellow-400 mb-3"
                >
                  <line x1="9" y1="18" x2="15" y2="18"></line>
                  <line x1="10" y1="22" x2="14" y2="22"></line>
                  <path
                    d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"
                  ></path>
                </svg>
                <h4 class="font-medium text-white text-lg mb-2">
                  Switch to LED Bulbs
                </h4>
                <p class="text-gray-400">
                  LED bulbs use up to 90% less energy than incandescent bulbs
                  and last much longer.
                </p>
              </div>
              <div
                class="bg-gray-800/30 p-5 rounded-xl border border-gray-700/50 shadow-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-7 w-7 text-indigo-400 mb-3"
                >
                  <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                  <polyline points="17 2 12 7 7 2"></polyline>
                </svg>
                <h4 class="font-medium text-white text-lg mb-2">
                  Unplug Devices
                </h4>
                <p class="text-gray-400">
                  Devices on standby can consume up to 10% of your home's
                  energy. Unplug when not in use.
                </p>
              </div>
              <div
                class="bg-gray-800/30 p-5 rounded-xl border border-gray-700/50 shadow-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-7 w-7 text-green-400 mb-3"
                >
                  <path
                    d="M5 6a7 7 0 1 1 14 0v10a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V6Z"
                  ></path>
                  <path d="M15 6v2"></path>
                  <path d="M9 6v2"></path>
                  <path d="M15 16v2"></path>
                  <path d="M9 16v2"></path>
                  <path d="M9 10h6"></path>
                  <path d="M5 14h14"></path>
                </svg>
                <h4 class="font-medium text-white text-lg mb-2">
                  Optimize Refrigerator
                </h4>
                <p class="text-gray-400">
                  Keep your refrigerator at 38°F and freezer at 5°F for optimal
                  energy efficiency.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Define appliance icons
      const applianceIcons = {
        Refrigerator: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M5 6a7 7 0 1 1 14 0v10a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V6Z"></path><path d="M15 6v2"></path><path d="M9 6v2"></path><path d="M15 16v2"></path><path d="M9 16v2"></path><path d="M9 10h6"></path><path d="M5 14h14"></path></svg>`,

        "Air Conditioner": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="2" y="6" width="20" height="12" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line><line x1="7" y1="12" x2="7" y2="18"></line><line x1="17" y1="12" x2="17" y2="18"></line><line x1="12" y1="6" x2="12" y2="12"></line></svg>`,

        Television: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>`,

        "Washing Machine": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,

        "Microwave Oven": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M6 8h.01"></path><circle cx="14" cy="12" r="4"></circle></svg>`,

        "Electric Iron": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="m8 3 4 3 4-3"></path><path d="M7 8h10a4 4 0 0 1 4 4v1a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-1a4 4 0 0 1 4-4Z"></path><path d="M17 17v3"></path><path d="M7 17v3"></path></svg>`,

        "Desktop Computer": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="2" y="3" width="20" height="14" rx="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`,

        Laptop: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"></path></svg>`,

        "Light Bulb (LED)": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="9" y1="18" x2="15" y2="18"></line><line x1="10" y1="22" x2="14" y2="22"></line><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path></svg>`,

        "Light Bulb (Incandescent)": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="9" y1="18" x2="15" y2="18"></line><line x1="10" y1="22" x2="14" y2="22"></line><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8A6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path></svg>`,

        "Electric Fan": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 6a2 2 0 0 0-2 2c0 1 .6 1.5 1 2 .4.5 1 1 1 2a2 2 0 0 1-4 0c0-1 .6-1.5 1-2 .4-.5 1-1 1-2a2 2 0 0 0-2-2a2 2 0 1 0 0 4c1 0 1.5-.6 2-1 .5-.4 1-1 1-1a2 2 0 0 1 0 4 2 2 0 0 0 0-4c-1 0-1.5.6-2 1-.5.4-1 1-1 1a2 2 0 0 1-2-2c0-1 .6-1.5 1-2 .4-.5 1-1 1-2a2 2 0 0 1 4 0c0 1-.6 1.5-1 2-.4.5-1 1-1 2a2 2 0 0 0 2 2 2 2 0 1 0 0-4c-1 0-1.5.6-2 1-.5.4-1 1-2 1a2 2 0 0 1 0-4 2 2 0 0 0 0 4c1 0 1.5-.6 2-1 .5-.4 1-1 2-1a2 2 0 0 1 2 2Z"></path></svg>`,

        "Water Heater": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"></path><path d="M12 14a6 6 0 0 0 6-6c0-1.4-.3-2.8-1-4a2 2 0 0 0-4 0 2 2 0 0 0-4 0c-.7 1.2-1 2.6-1 4a6 6 0 0 0 6 6Z"></path><path d="M16 9a4 4 0 0 1-8 0"></path></svg>`,

        Toaster: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M6 8v8a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V8H6Z"></path><path d="M19 6v2H5V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z"></path><path d="M8 12h8"></path><path d="M9 19v1"></path><path d="M15 19v1"></path></svg>`,

        "Coffee Maker": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"></path><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"></path><line x1="6" y1="2" x2="6" y2="4"></line><line x1="10" y1="2" x2="10" y2="4"></line><line x1="14" y1="2" x2="14" y2="4"></line></svg>`,

        "Vacuum Cleaner": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 22a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"></path><path d="M5 11V7a7 7 0 0 1 14 0v4"></path><rect x="7" y="1" width="2" height="4"></rect><rect x="15" y="1" width="2" height="4"></rect></svg>`,

        "Smartphone Charger": `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12" y2="18"></line><path d="M7 9h10"></path><path d="M7 5h10"></path></svg>`,

        // Default icon is now a zap icon
        custom: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
      };

      // Function to get appliance details including icon and wattage
      function updateApplianceDetails(value) {
        const customField = document.getElementById("customApplianceField");
        const iconContainer = document.getElementById("applianceIcon");

        // Handle custom appliance field visibility
        if (value === "custom") {
          customField.style.display = "block";
          document.getElementById("wattage").value = "";
          iconContainer.innerHTML = applianceIcons["custom"];
        } else {
          customField.style.display = "none";

          // Set wattage and icon for pre-defined appliances
          if (value) {
            const appliances = [
              { name: "Refrigerator", wattage: 150 },
              { name: "Air Conditioner", wattage: 1500 },
              { name: "Television", wattage: 100 },
              { name: "Washing Machine", wattage: 500 },
              { name: "Microwave Oven", wattage: 1000 },
              { name: "Electric Iron", wattage: 1100 },
              { name: "Desktop Computer", wattage: 200 },
              { name: "Laptop", wattage: 50 },
              { name: "Light Bulb (LED)", wattage: 10 },
              { name: "Light Bulb (Incandescent)", wattage: 60 },
              { name: "Electric Fan", wattage: 70 },
              { name: "Water Heater", wattage: 4000 },
              { name: "Toaster", wattage: 850 },
              { name: "Coffee Maker", wattage: 800 },
              { name: "Vacuum Cleaner", wattage: 1400 },
              { name: "Smartphone Charger", wattage: 5 },
            ];

            const appliance = appliances.find((a) => a.name === value);
            if (appliance) {
              document.getElementById("wattage").value = appliance.wattage;

              // Update the icon
              iconContainer.innerHTML =
                applianceIcons[value] || applianceIcons["custom"];
            }
          }
        }
      }

      // Update slider max value and labels based on selected time unit
      function updateSliderMax(unit) {
        const slider = document.getElementById("hoursUsed");
        const labels = document.getElementById("sliderLabels");
        let max, steps;
        switch (unit) {
          case "days":
            max = 30; // Up to 30 days
            steps = ["0.1d", "7.5d", "15d", "22.5d", "30d"];
            break;
          case "weeks":
            max = 12; // Up to 12 weeks
            steps = ["0.1w", "3w", "6w", "9w", "12w"];
            break;
          case "months":
            max = 12; // Up to 12 months
            steps = ["0.1m", "3m", "6m", "9m", "12m"];
            break;
          default: // hours
            max = 24;
            steps = ["0.1h", "6h", "12h", "18h", "24h"];
            break;
        }
        slider.max = max;
        slider.value = Math.min(slider.value, max);
        updateHoursDisplay(slider.value, unit);
        labels.innerHTML = steps.map((step) => `<span>${step}</span>`).join("");
      }

      // Update hours display when slider or unit changes
      function updateHoursDisplay(value, unit) {
        document.getElementById(
          "hoursDisplay"
        ).textContent = `${value} ${unit}`;
      }

      // Format number with commas for thousands separators
      function formatNumber(input) {
        // Get the current cursor position
        const cursorPos = input.selectionStart;

        // Store the original length of the input value
        const originalLength = input.value.length;

        // Remove all non-numeric characters
        const numericValue = input.value.replace(/[^\d]/g, "");

        // If empty after removing non-numerics, just set to empty
        if (!numericValue) {
          input.value = "";
          return;
        }

        // Parse the numeric value
        const numValue = parseInt(numericValue, 10);

        // Don't format if it's NaN
        if (isNaN(numValue)) {
          input.value = "";
          return;
        }

        // Format with commas
        const formattedValue = numValue.toLocaleString("en-US");

        // Calculate new cursor position (adjust for added/removed commas)
        const newLength = formattedValue.length;
        const lengthDiff = newLength - originalLength;
        let newCursorPos = cursorPos + lengthDiff;

        // Ensure cursor is in valid range
        newCursorPos = Math.max(0, Math.min(newCursorPos, newLength));

        // Set the new value
        input.value = formattedValue;

        // Restore cursor position
        input.setSelectionRange(newCursorPos, newCursorPos);
      }

      // Update icons in history view
      function updateHistoryIcons() {
        const historyIcons = document.querySelectorAll(
          ".history-appliance-icon"
        );
        historyIcons.forEach((icon) => {
          const applianceName = icon.getAttribute("data-appliance");
          icon.innerHTML =
            applianceIcons[applianceName] || applianceIcons["custom"];
        });
      }

      // Update the result view icon if available
      function updateResultIcon() {
        const resultIcon = document.getElementById("resultApplianceIcon");
        if (resultIcon) {
          const applianceName = resultIcon.getAttribute("data-appliance");
          resultIcon.innerHTML =
            applianceIcons[applianceName] || applianceIcons["custom"];
        }
      }

      // Reset form completely
      function resetForm() {
        const form = document.getElementById("calculationForm");
        if (form) {
          form.reset();
          document.getElementById("customApplianceField").style.display =
            "none";
          document.getElementById("applianceIcon").innerHTML =
            applianceIcons["custom"];
          updateSliderMax("hours"); // Reset to hours
          updateHoursDisplay(1, "hours"); // Reset display
        }
      }

      // Function to switch between tabs
      function switchTab(tabId) {
        // Hide all tabs
        document.querySelectorAll(".content-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active class from all nav links
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("nav-item-active", "text-indigo-400");
          link.classList.add(
            "text-gray-400",
            "hover:bg-opacity-5",
            "hover:bg-white"
          );
        });

        // Activate the selected tab
        const selectedTab = document.getElementById(tabId + "-tab");
        if (selectedTab) {
          selectedTab.classList.add("active");
        }

        // Highlight the active nav link
        const activeNavLink = document.querySelector(
          `.nav-link[data-tab="${tabId}"]`
        );
        if (activeNavLink) {
          activeNavLink.classList.add("nav-item-active", "text-indigo-400");
          activeNavLink.classList.remove(
            "text-gray-400",
            "hover:bg-opacity-5",
            "hover:bg-white"
          );
        }

        // Special handling for results and history tabs
        if (tabId === "results") {
          checkEmptyResults();
        } else if (tabId === "history") {
          checkEmptyHistory();
        } else if (tabId === "input") {
          // Clear the form when switching to input tab from another tab
          const activeTab = document.querySelector(".content-tab.active");
          if (activeTab && activeTab.id !== "input-tab") {
            resetForm();
          }
        }
      }

      // Show/hide empty states based on data availability
      function checkEmptyResults() {
        const resultsContent = document.getElementById("resultsContent");
        const noResultsMessage = document.getElementById("noResultsMessage");

        if (!resultsContent || resultsContent.children.length === 0) {
          if (noResultsMessage) noResultsMessage.style.display = "block";
          if (resultsContent) resultsContent.style.display = "none";
        } else {
          if (noResultsMessage) noResultsMessage.style.display = "none";
          if (resultsContent) resultsContent.style.display = "grid";
        }
      }

      function checkEmptyHistory() {
        const historyContent = document.getElementById("historyContent");
        const noHistoryMessage = document.getElementById("noHistoryMessage");
        const clearAllLink = document.getElementById("clearAllLink");

        if (!historyContent || historyContent.children.length === 0) {
          if (noHistoryMessage) noHistoryMessage.style.display = "block";
          if (historyContent) historyContent.style.display = "none";
          if (clearAllLink) clearAllLink.style.display = "none";
        } else {
          if (noHistoryMessage) noHistoryMessage.style.display = "none";
          if (historyContent) historyContent.style.display = "block";
          if (clearAllLink) clearAllLink.style.display = "flex";
        }
      }

      // Handle form submission via AJAX
      // Handle form submission via AJAX
      function setupFormSubmission() {
        const form = document.getElementById("calculationForm");
        if (form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Show loading state
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerText;
            submitButton.innerHTML =
              '<span class="inline-block animate-spin mr-2">↻</span> Processing...';
            submitButton.disabled = true;

            // Get the raw wattage value without commas
            const wattageInput = document.getElementById("wattage");
            const rawWattage = wattageInput.value.replace(/,/g, "");

            // Create FormData object
            const formData = new FormData(form);

            // Remove the original wattage with commas and add the raw value
            formData.delete("wattage");
            formData.append("wattage", rawWattage);

            // Send AJAX request with a 3-second delay
            setTimeout(() => {
              fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                  "X-Requested-With": "XMLHttpRequest",
                },
              })
                .then((response) => response.text())
                .then((html) => {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(html, "text/html");

                  // Update results tab
                  const newResultsTab = doc.getElementById("results-tab");
                  const currentResultsTab =
                    document.getElementById("results-tab");
                  if (newResultsTab && currentResultsTab) {
                    currentResultsTab.innerHTML = newResultsTab.innerHTML;
                  }

                  // Update history tab
                  const newHistoryTab = doc.getElementById("history-tab");
                  const currentHistoryTab =
                    document.getElementById("history-tab");
                  if (newHistoryTab && currentHistoryTab) {
                    currentHistoryTab.innerHTML = newHistoryTab.innerHTML;
                  }

                  // Update stats summary
                  const newStatsSummary = doc.getElementById("statsSummary");
                  const currentStatsSummary =
                    document.getElementById("statsSummary");
                  if (newStatsSummary) {
                    if (currentStatsSummary) {
                      currentStatsSummary.innerHTML = newStatsSummary.innerHTML;
                      // Instead of just setting display, let updateStatsSummary handle it
                    } else {
                      // Create statsSummary if it didn’t exist
                      const navContainer = document.querySelector(
                        ".lg\\:col-span-1 .card-glass"
                      );
                      if (navContainer) {
                        const statsDiv = document.createElement("div");
                        statsDiv.id = "statsSummary";
                        statsDiv.className = "p-5 border-t border-gray-800";
                        statsDiv.innerHTML = newStatsSummary.innerHTML;
                        navContainer.appendChild(statsDiv);
                      }
                    }
                    // Update and set display based on record count
                    updateStatsSummary(doc);
                  } else {
                    if (currentStatsSummary) {
                      currentStatsSummary.style.display = "none";
                    }
                  }

                  // Update history count
                  const newHistoryCount = doc.getElementById("historyCount");
                  const currentHistoryCount =
                    document.getElementById("historyCount");
                  if (newHistoryCount && currentHistoryCount) {
                    currentHistoryCount.textContent =
                      newHistoryCount.textContent;
                  }

                  // Update icons
                  updateHistoryIcons();
                  updateResultIcon();

                  // Switch to results tab
                  switchTab("results");

                  // Reset form
                  resetForm();

                  // Reset submit button
                  submitButton.innerHTML = originalText;
                  submitButton.disabled = false;
                })
                .catch((error) => {
                  console.error("Error submitting form:", error);
                  submitButton.innerHTML = originalText;
                  submitButton.disabled = false;
                  alert(
                    "There was an error processing your request. Please try again."
                  );
                });
            }, 3000); // 3-second delay
          });
        }
      }
      // Extract usage data from the DOM
      function extractUsageData(doc) {
        const usageHistory = [];
        const historyItems = doc.querySelectorAll(".history-item");

        historyItems.forEach((item) => {
          try {
            const id = item.id.replace("history-item-", "");
            const applianceName = item.querySelector("h4").textContent.trim();
            const date = item
              .querySelector(".text-gray-400.text-xs")
              .textContent.trim();

            const dataBoxes = item.querySelectorAll(".bg-gray-800\\/50");

            // Extract text values from each box
            const wattageText = dataBoxes[0]
              .querySelector(".text-white.font-medium")
              .textContent.trim();
            const durationText = dataBoxes[1]
              .querySelector(".text-white.font-medium")
              .textContent.trim();
            const energyText = dataBoxes[2]
              .querySelector(".text-white.font-medium")
              .textContent.trim();
            const costText = dataBoxes[3]
              .querySelector(".text-white.font-medium")
              .textContent.trim();

            // Extract numeric values
            const wattage = parseInt(wattageText.replace(/[^\d]/g, ""));
            const kWhConsumed = parseFloat(energyText.replace(/[^\d.]/g, ""));
            const cost = parseFloat(costText.replace(/[^\d.]/g, ""));

            // Extract hours and time unit
            const durationParts = durationText.split(" ");
            const hoursUsed = parseFloat(durationParts[0]);
            const timeUnit = durationParts[1];

            usageHistory.push({
              id,
              applianceName,
              wattage,
              hoursUsed,
              timeUnit,
              kWhConsumed,
              cost,
              date,
            });
          } catch (err) {
            console.error("Error parsing history item:", err);
          }
        });

        return usageHistory;
      }

      // Update the results tab with the latest usage data
      function updateResultsTab(usage) {
        if (!usage) return;

        document.getElementById("resultApplianceName").textContent =
          usage.applianceName;
        document.getElementById(
          "resultApplianceDetails"
        ).textContent = `${usage.wattage.toLocaleString()} watts • ${
          usage.hoursUsed
        } ${usage.timeUnit}`;
        document.getElementById("resultKwh").textContent =
          usage.kWhConsumed.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

        // Update progress bar
        const kwhBarWidth =
          usage.kWhConsumed > 5 ? 100 : usage.kWhConsumed * 20;
        document.getElementById("resultKwhBar").style.width = `${kwhBarWidth}%`;

        // Update cost
        document.getElementById("resultCost").textContent =
          usage.cost.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

        // Update budget percentage
        const budgetPercent = (usage.cost / 1000) * 100;
        document.getElementById(
          "resultBudgetPercent"
        ).textContent = `This is approximately ${budgetPercent.toLocaleString(
          undefined,
          { minimumFractionDigits: 1, maximumFractionDigits: 1 }
        )}% of a ₦1,000 daily energy budget`;

        // Update cost bar
        const costBarWidth =
          usage.cost > 1000 ? 100 : (usage.cost / 1000) * 100;
        document.getElementById(
          "resultCostBar"
        ).style.width = `${costBarWidth}%`;

        // Update appliance icon
        document
          .getElementById("resultApplianceIcon")
          .setAttribute("data-appliance", usage.applianceName);
        updateResultIcon();

        // Show results content, hide no results message
        document.getElementById("resultsContent").style.display = "grid";
        document.getElementById("noResultsMessage").style.display = "none";
      }

      // Update the history tab with new usage data
      function updateHistoryTab(usageHistory) {
        const historyContent = document.getElementById("historyContent");

        // Clear existing content
        historyContent.innerHTML = "";

        // Add new items
        usageHistory.forEach((usage) => {
          const historyItem = document.createElement("div");
          historyItem.id = `history-item-${usage.id}`;
          historyItem.className =
            "history-item bg-gray-900/60 rounded-lg p-5 hover:bg-gray-800/60 transition-colors animate__animated animate__fadeIn shadow-md border border-gray-800/60";

          historyItem.innerHTML = `
            <div class="flex justify-between">
              <div class="flex items-center gap-3">
                <div class="p-2.5 bg-indigo-900/30 rounded-lg history-appliance-icon" data-appliance="${
                  usage.applianceName
                }">
                  ${
                    applianceIcons[usage.applianceName] ||
                    applianceIcons["custom"]
                  }
                </div>
                <div>
                  <h4 class="font-medium text-white">${usage.applianceName}</h4>
                  <p class="text-gray-400 text-xs">${usage.date}</p>
                </div>
              </div>
              <a href="#" onclick="deleteUsage(${
                usage.id
              }); return false;" data-id="${usage.id}" data-href="/delete/${
            usage.id
          }" class="delete-link h-8 w-8 flex items-center justify-center text-gray-500 hover:text-white hover:bg-gray-700 rounded-md transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </a>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
              <div class="bg-gray-800/50 p-3 rounded-lg">
                <p class="text-gray-400 text-xs">Wattage</p>
                <p class="text-white font-medium">${usage.wattage.toLocaleString()} W</p>
              </div>
              <div class="bg-gray-800/50 p-3 rounded-lg">
                <p class="text-gray-400 text-xs">Duration</p>
                <p class="text-white font-medium">${usage.hoursUsed} ${
            usage.timeUnit
          }</p>
              </div>
              <div class="bg-gray-800/50 p-3 rounded-lg">
                <p class="text-gray-400 text-xs">Energy</p>
                <p class="text-white font-medium">${usage.kWhConsumed.toLocaleString(
                  undefined,
                  { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                )} kWh</p>
              </div>
              <div class="bg-gray-800/50 p-3 rounded-lg">
                <p class="text-gray-400 text-xs">Cost</p>
                <p class="text-white font-medium">₦${usage.cost.toLocaleString(
                  undefined,
                  { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                )}</p>
              </div>
            </div>
          `;

          historyContent.appendChild(historyItem);
        });

        // Update empty state
        checkEmptyHistory();

        // Update record count
        const recordCount = usageHistory.length;
        const historyCount = document.getElementById("historyCount");
        if (historyCount) {
          historyCount.textContent = recordCount.toLocaleString();
        }
      }

      // Update stats summary
      function updateStatsSummary(doc) {
        const statsSummary = document.getElementById("statsSummary");
        if (!statsSummary) return;

        // Extract total energy, cost and record count
        const totalEnergyText =
          doc.getElementById("totalEnergyDisplay")?.textContent || "0 kWh";
        const totalCostText =
          doc.getElementById("totalCostDisplay")?.textContent || "₦0";
        const recordCountText =
          doc.getElementById("recordCountDisplay")?.textContent || "0";

        // Parse values
        const totalEnergy = parseFloat(totalEnergyText.replace(/[^\d.]/g, ""));
        const totalCost = parseFloat(totalCostText.replace(/[^\d.]/g, ""));
        const recordCount = parseInt(recordCountText.replace(/[^\d]/g, ""));

        // Update displays
        document.getElementById("totalEnergyDisplay").textContent =
          totalEnergyText;
        document.getElementById("totalCostDisplay").textContent = totalCostText;
        document.getElementById("recordCountDisplay").textContent =
          recordCountText;

        // Update progress bars
        document.getElementById("totalEnergyBar").style.width = `${
          totalEnergy > 10 ? 100 : totalEnergy * 10
        }%`;
        document.getElementById("totalCostBar").style.width = `${
          totalCost > 1000 ? 100 : totalCost / 10
        }%`;
        document.getElementById("recordCountBar").style.width = `${
          recordCount > 10 ? 100 : recordCount * 10
        }%`;

        // Show stats summary if there's data
        statsSummary.style.display = recordCount > 0 ? "block" : "none";
      }

      // Delete a usage record
      function deleteUsage(id) {
        if (!confirm("Are you sure you want to delete this record?")) return;
        const deleteLink = document.querySelector(
          `.delete-link[data-id="${id}"]`
        );
        const deleteUrl = deleteLink.getAttribute("data-href");
        deleteLink.innerHTML =
          '<span class="animate-spin inline-block">↻</span>';

        fetch(deleteUrl, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            [csrfHeader]: csrfToken,
          },
        })
          .then((response) => {
            if (!response.ok) throw new Error("Delete failed");
            return response.text();
          })
          .then((html) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const usageHistory = extractUsageData(doc);
            updateHistoryTab(usageHistory);
            updateStatsSummary(doc);
            if (usageHistory.length > 0) updateResultsTab(usageHistory[0]);
            else {
              document.getElementById("resultsContent").style.display = "none";
              document.getElementById("noResultsMessage").style.display =
                "block";
            }
          })
          .catch((error) => {
            console.error("Error deleting record:", error);
            alert("Failed to delete record.");
            deleteLink.innerHTML = "<svg ...>"; // Restore icon
          });
      }

      // Update clearAllUsages
      function clearAllUsages() {
        if (!confirm("Are you sure you want to delete all records?")) return;
        const clearAllLink = document.getElementById("clearAllLink");
        const clearAllUrl = clearAllLink.getAttribute("data-href");
        clearAllLink.innerHTML =
          '<span class="animate-spin inline-block mr-1">↻</span> Clearing...';

        fetch(clearAllUrl, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            [csrfHeader]: csrfToken,
          },
        })
          .then((response) => {
            if (!response.ok) throw new Error("Clear failed");
            return response.text();
          })
          .then(() => {
            document.getElementById("historyContent").innerHTML = "";
            checkEmptyHistory();
            document.getElementById("resultsContent").style.display = "none";
            document.getElementById("noResultsMessage").style.display = "block";
            document.getElementById("statsSummary").style.display = "none";
            document.getElementById("historyCount").textContent = "";
            clearAllLink.innerHTML = "<svg ...> Clear All"; // Restore text
          })
          .catch((error) => {
            console.error("Error clearing records:", error);
            alert("Failed to clear records.");
            clearAllLink.innerHTML = "<svg ...> Clear All";
          });
      }
      // Initialize everything when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Check URL parameters and set initial tab
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get("view");

        if (viewParam) {
          switchTab(viewParam);
        } else {
          switchTab("input");
        }

        // Setup tab navigation
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const tabId = this.getAttribute("data-tab");
            switchTab(tabId);

            // Update URL without page reload
            history.pushState({}, "", `?view=${tabId}`);
          });
        });

        // Setup form submission
        setupFormSubmission();

        // Initialize slider and icons
        updateSliderMax("hours");
        updateHistoryIcons();
        updateResultIcon();

        // Check empty states
        checkEmptyResults();
        checkEmptyHistory();
      });
    </script>
  </body>
</html>
